<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Matriz RACI - TÓTAL REPORT®</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Markdown Parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* Slate 50 - Light background */
            color: #0f172a; /* Slate 900 - Dark text */
        }
        .font-mono {
            font-family: 'JetBrains Mono', monospace;
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9; 
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; 
        }

        /* Sticky Columns/Header logic */
        th {
            position: sticky;
            top: 0;
            z-index: 20;
            background-color: #ffffff; /* Default solid white */
        }
        td:first-child, th:first-child {
            position: sticky;
            left: 0;
            z-index: 30;
            background-color: #ffffff;
        }
        th:first-child {
            z-index: 40;
        }

        /* RACI Badges - Optimized for Light Mode */
        .badge-base {
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }
        .badge-R { background-color: #eff6ff; color: #1d4ed8; border: 1px solid #bfdbfe; } /* Blue-50 to Blue-700 */
        .badge-A { background-color: #fef2f2; color: #b91c1c; border: 1px solid #fecaca; } /* Red-50 to Red-700 */
        .badge-C { background-color: #f0fdf4; color: #15803d; border: 1px solid #bbf7d0; } /* Green-50 to Green-700 */
        .badge-I { background-color: #f8fafc; color: #475569; border: 1px solid #e2e8f0; } /* Slate-50 to Slate-600 */

        /* Highlight effects */
        .highlight-col { background-color: #eff6ff !important; } /* Light blue highlight */
        .highlight-cell { 
            transform: scale(1.1); 
            font-weight: 700; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); 
        }
        
        .glass-panel {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(226, 232, 240, 0.8); /* Slate-200 */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
        }

        /* Table borders */
        .table-border {
            border-color: #e2e8f0; /* Slate-200 */
        }
        
        /* Column shadow for scroll */
        .sticky-shadow {
            box-shadow: 4px 0 12px -4px rgba(0,0,0,0.1);
        }

        /* AI Modal Animations */
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .ai-panel-enter {
            animation: slideIn 0.3s ease-out forwards;
        }
        .prose p {
            margin-bottom: 0.5em;
        }
        .prose ul {
            list-style-type: disc;
            padding-left: 1.5em;
            margin-bottom: 0.5em;
        }
        .prose strong {
            color: #0f172a;
            font-weight: 600;
        }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8 bg-slate-50 relative overflow-x-hidden">

    <!-- Header Section -->
    <header class="max-w-7xl mx-auto mb-8 flex flex-col md:flex-row justify-between items-start md:items-center border-b border-slate-200 pb-6">
        <div>
            <div class="flex items-center gap-3 mb-2">
                <div class="w-3 h-3 rounded-full bg-emerald-500 animate-pulse shadow-sm"></div>
                <span class="text-xs font-mono text-emerald-600 font-semibold tracking-widest uppercase">Ecosistema Activo</span>
            </div>
            <h1 class="text-3xl md:text-4xl font-bold text-slate-900 tracking-tight">
                Matriz RACI <span class="text-slate-300 mx-2">|</span> <span class="text-blue-600">TÓTAL ECOSYSTEM®</span>
            </h1>
            <p class="text-slate-500 mt-2 max-w-2xl text-sm leading-relaxed">
                Documentación técnica de roles y responsabilidades para la fase de implementación, migración y despliegue normativo.
            </p>
        </div>
        <div class="mt-4 md:mt-0 text-right flex flex-col items-end gap-2">
            <div class="flex gap-2">
                <button onclick="openApiKeyModal()" class="px-3 py-2 bg-slate-100 hover:bg-slate-200 text-slate-600 rounded-md transition-colors" title="Configurar API Key">
                    <i data-lucide="key" class="w-4 h-4"></i>
                </button>
                <button onclick="toggleAI()" class="px-4 py-2 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white shadow-md rounded-md text-xs font-bold transition-all flex items-center gap-2 border border-transparent">
                    <i data-lucide="sparkles" class="w-4 h-4"></i>
                    Asistente TOTALiA
                </button>
                <button onclick="window.print()" class="px-4 py-2 bg-white hover:bg-slate-50 border border-slate-200 text-slate-700 shadow-sm rounded-md text-xs font-semibold transition-all flex items-center gap-2">
                    <i data-lucide="printer" class="w-4 h-4"></i>
                    PDF
                </button>
            </div>
            <div class="text-xs text-slate-400 font-mono">VERSIÓN 2.5.0 (LIGHT)</div>
            <div class="text-xs text-slate-400 font-mono">CONFIDENCIAL</div>
            <div class="text-xs text-slate-400 font-mono">Andrey Ramírez C.T.O.</div>
        </div>
    </header>

    <!-- Controls & Legend -->
    <section class="max-w-7xl mx-auto mb-6 grid grid-cols-1 lg:grid-cols-4 gap-4">
        
        <!-- Legend Box -->
        <div class="lg:col-span-3 glass-panel rounded-xl p-4 flex flex-wrap gap-4 items-center justify-between">
            <span class="text-xs font-bold text-slate-400 uppercase tracking-wider mr-2">Leyenda Interactiva:</span>
            
            <button onclick="highlightType('R')" class="flex items-center gap-2 px-3 py-1.5 rounded-lg bg-white hover:bg-slate-50 border border-slate-200 shadow-sm transition-all group">
                <span class="badge-R badge-base w-6 h-6 flex items-center justify-center rounded text-xs font-bold">R</span>
                <div class="flex flex-col text-left">
                    <span class="text-xs font-bold text-slate-700">Responsible</span>
                    <span class="text-[10px] text-slate-500">Ejecuta la tarea</span>
                </div>
            </button>

            <button onclick="highlightType('A')" class="flex items-center gap-2 px-3 py-1.5 rounded-lg bg-white hover:bg-slate-50 border border-slate-200 shadow-sm transition-all group">
                <span class="badge-A badge-base w-6 h-6 flex items-center justify-center rounded text-xs font-bold">A</span>
                <div class="flex flex-col text-left">
                    <span class="text-xs font-bold text-slate-700">Accountable</span>
                    <span class="text-[10px] text-slate-500">Dueño / Aprueba</span>
                </div>
            </button>

            <button onclick="highlightType('C')" class="flex items-center gap-2 px-3 py-1.5 rounded-lg bg-white hover:bg-slate-50 border border-slate-200 shadow-sm transition-all group">
                <span class="badge-C badge-base w-6 h-6 flex items-center justify-center rounded text-xs font-bold">C</span>
                <div class="flex flex-col text-left">
                    <span class="text-xs font-bold text-slate-700">Consulted</span>
                    <span class="text-[10px] text-slate-500">Experto consultado</span>
                </div>
            </button>

            <button onclick="highlightType('I')" class="flex items-center gap-2 px-3 py-1.5 rounded-lg bg-white hover:bg-slate-50 border border-slate-200 shadow-sm transition-all group">
                <span class="badge-I badge-base w-6 h-6 flex items-center justify-center rounded text-xs font-bold">I</span>
                <div class="flex flex-col text-left">
                    <span class="text-xs font-bold text-slate-700">Informed</span>
                    <span class="text-[10px] text-slate-500">Notificado</span>
                </div>
            </button>
            
            <button onclick="resetHighlights()" class="text-xs text-blue-600 hover:text-blue-800 font-medium underline ml-auto decoration-blue-200 hover:decoration-blue-800 transition-all">Resetear Vistas</button>
        </div>

        <!-- Role Filter Dropdown -->
        <div class="lg:col-span-1 glass-panel rounded-xl p-4 flex items-center">
             <select id="roleFilter" onchange="highlightColumn(this.value)" class="w-full bg-white border border-slate-200 text-slate-700 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5 shadow-sm cursor-pointer">
                <option value="-1">Filtrar por Rol / Columna...</option>
                <option value="1">Arquitectura TI</option>
                <option value="2">Riesgo</option>
                <option value="3">Cumplimiento</option>
                <option value="4">Área Normativa</option>
                <option value="5">Equipo Técnico TÓTAL</option>
                <option value="6">Auditoría</option>
                <option value="7">Proveedor Infra</option>
            </select>
        </div>
    </section>

    <!-- Main Table Container -->
    <main class="max-w-7xl mx-auto">
        <div class="glass-panel rounded-xl overflow-hidden shadow-xl relative bg-white">
            <div class="overflow-x-auto max-h-[70vh]">
                <table class="w-full text-sm text-left border-collapse" id="raciTable">
                    <thead class="text-xs text-slate-500 uppercase bg-white border-b border-slate-200 font-mono tracking-wide">
                        <tr>
                            <!-- FIX: Changed bg-slate-50/50 to bg-slate-50 (solid) -->
                            <th scope="col" class="px-6 py-4 min-w-[250px] border-r border-slate-200 sticky-shadow bg-slate-50">
                                Actividad / Fase
                            </th>
                            <th scope="col" class="px-4 py-4 min-w-[140px] text-center hover:bg-slate-50 cursor-pointer transition-colors" onclick="highlightColumn(1)">Arquitectura TI</th>
                            <th scope="col" class="px-4 py-4 min-w-[100px] text-center hover:bg-slate-50 cursor-pointer transition-colors" onclick="highlightColumn(2)">Riesgo</th>
                            <th scope="col" class="px-4 py-4 min-w-[130px] text-center hover:bg-slate-50 cursor-pointer transition-colors" onclick="highlightColumn(3)">Cumplimiento</th>
                            <th scope="col" class="px-4 py-4 min-w-[140px] text-center hover:bg-slate-50 cursor-pointer transition-colors" onclick="highlightColumn(4)">Área Normativa</th>
                            <!-- FIX: Changed bg-blue-50/30 to bg-blue-50 (solid) to prevent overlap -->
                            <th scope="col" class="px-4 py-4 min-w-[160px] text-center hover:bg-slate-50 cursor-pointer text-blue-600 font-bold bg-blue-50 transition-colors" onclick="highlightColumn(5)">Equipo Técnico TÓTAL</th>
                            <th scope="col" class="px-4 py-4 min-w-[100px] text-center hover:bg-slate-50 cursor-pointer transition-colors" onclick="highlightColumn(6)">Auditoría</th>
                            <th scope="col" class="px-4 py-4 min-w-[160px] text-center hover:bg-slate-50 cursor-pointer transition-colors" onclick="highlightColumn(7)">Proveedor Infra</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-100 text-slate-600" id="tableBody">
                        <!-- Javascript will populate this based on the matrix data -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Footer Notes -->
        <div class="mt-6 flex flex-col md:flex-row justify-between text-xs text-slate-400 font-mono border-t border-slate-200 pt-4">
            <p>Generado automáticamento por TOTALiA®. Uso interno.</p>
            <p>Última actualización: Septiembre 2025</p>
        </div>
    </main>

    <!-- AI Side Panel -->
    <div id="aiPanel" class="fixed inset-y-0 right-0 w-full md:w-[450px] bg-white shadow-2xl transform translate-x-full transition-transform duration-300 z-50 flex flex-col border-l border-slate-200">
        <!-- Panel Header -->
        <div class="p-6 border-b border-slate-100 bg-slate-50 flex justify-between items-center">
            <div class="flex items-center gap-2">
                <i data-lucide="bot" class="text-blue-600"></i>
                <h2 class="font-bold text-slate-800">Asistente TOTALiA®</h2>
            </div>
            <button onclick="toggleAI()" class="text-slate-400 hover:text-slate-600">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
        </div>

        <!-- Scrollable Content Area -->
        <div id="aiContent" class="flex-1 overflow-y-auto p-6 space-y-6 bg-white">
            
            <!-- Welcome State -->
            <div id="aiWelcome" class="text-center space-y-4 mt-10">
                <div class="w-16 h-16 bg-blue-50 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i data-lucide="sparkles" class="w-8 h-8 text-blue-500"></i>
                </div>
                <h3 class="text-lg font-semibold text-slate-900">¿En qué puedo ayudarte hoy?</h3>
                <p class="text-sm text-slate-500 max-w-xs mx-auto">Puedo analizar inconsistencias en la matriz RACI o responder preguntas específicas sobre roles.</p>
                
                <!-- API Key Missing Warning -->
                <div id="apiKeyWarning" class="hidden p-4 bg-orange-50 border border-orange-200 rounded-lg text-left mt-4">
                    <div class="flex items-start gap-2">
                        <i data-lucide="alert-circle" class="w-4 h-4 text-orange-500 mt-1"></i>
                        <div>
                            <h4 class="font-bold text-orange-800 text-xs uppercase">Requiere Configuración</h4>
                            <p class="text-xs text-orange-700 mt-1">Para usar la IA, necesitas configurar tu API Key gratuita de Gemini.</p>
                            <button onclick="openApiKeyModal()" class="text-xs underline text-orange-900 font-bold mt-2">Configurar ahora</button>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 gap-3 mt-6">
                    <button onclick="runAudit()" class="p-3 text-left text-sm border border-slate-200 rounded-lg hover:bg-slate-50 hover:border-blue-300 transition-all flex items-center gap-3 group">
                        <span class="bg-indigo-100 text-indigo-600 p-2 rounded-md group-hover:bg-indigo-200"><i data-lucide="search-check" class="w-4 h-4"></i></span>
                        <div>
                            <span class="font-semibold block text-slate-700">Auditoría RACI</span>
                            <span class="text-xs text-slate-400">Detectar vacíos de responsabilidad</span>
                        </div>
                    </button>
                     <button onclick="askQuestion('¿Qué actividades no tienen un Dueño (A) asignado?')" class="p-3 text-left text-sm border border-slate-200 rounded-lg hover:bg-slate-50 hover:border-blue-300 transition-all flex items-center gap-3 group">
                        <span class="bg-rose-100 text-rose-600 p-2 rounded-md group-hover:bg-rose-200"><i data-lucide="alert-triangle" class="w-4 h-4"></i></span>
                        <div>
                            <span class="font-semibold block text-slate-700">Ver Riesgos Críticos</span>
                            <span class="text-xs text-slate-400">Buscar tareas huérfanas</span>
                        </div>
                    </button>
                </div>
            </div>

            <!-- Chat Output -->
            <div id="aiOutput" class="space-y-4 hidden">
                <!-- Messages go here -->
            </div>

            <!-- Loading State -->
            <div id="aiLoading" class="hidden flex flex-col items-center justify-center py-10">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mb-3"></div>
                <span class="text-sm text-slate-500 animate-pulse">Analizando ecosistema...</span>
            </div>
        </div>

        <!-- Input Area -->
        <div class="p-4 border-t border-slate-100 bg-slate-50">
            <div class="relative">
                <input type="text" id="userQuery" placeholder="Pregunta sobre la matriz..." 
                       class="w-full pl-4 pr-12 py-3 bg-white border border-slate-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent shadow-sm"
                       onkeypress="if(event.key === 'Enter') handleCustomQuery()">
                <button onclick="handleCustomQuery()" class="absolute right-2 top-2 p-1 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors">
                    <i data-lucide="send" class="w-4 h-4"></i>
                </button>
            </div>
            <p class="text-[10px] text-center text-slate-400 mt-2">Potenciado por Gemini 2.5 Flash</p>
        </div>
    </div>

    <!-- API Key Modal -->
    <div id="apiKeyModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4 opacity-0 transition-opacity duration-300">
        <div class="bg-white rounded-xl shadow-2xl max-w-md w-full p-6 transform scale-95 transition-transform duration-300" id="apiKeyModalContent">
            <div class="flex items-center gap-3 mb-4">
                <div class="p-2 bg-blue-100 rounded-lg">
                    <i data-lucide="key" class="text-blue-600 w-6 h-6"></i>
                </div>
                <h3 class="text-lg font-bold text-slate-800">Configuración de API</h3>
            </div>
            
            <p class="text-sm text-slate-600 mb-4 leading-relaxed">
                Para utilizar las funciones de IA en esta versión portable, necesitas tu propia 
                <strong>Google Gemini API Key</strong>. Es gratuita y segura.
            </p>
            
            <ol class="text-xs text-slate-500 list-decimal ml-4 mb-4 space-y-1">
                <li>Ve a <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-blue-600 underline">Google AI Studio</a>.</li>
                <li>Crea una nueva API Key.</li>
                <li>Pégala aquí abajo.</li>
            </ol>
            
            <div class="space-y-2">
                <label class="text-xs font-bold text-slate-700 uppercase">Tu API Key</label>
                <input type="password" id="apiKeyInput" placeholder="AIzaSy..." class="w-full p-3 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none font-mono">
            </div>

            <div class="mt-6 flex justify-end gap-3">
                <button onclick="closeApiKeyModal()" class="px-4 py-2 text-slate-500 text-sm hover:text-slate-700">Cancelar</button>
                <button onclick="saveApiKey()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-bold shadow-md">Guardar Key</button>
            </div>
            
            <p class="text-[10px] text-slate-400 mt-4 text-center">
                La llave se guarda únicamente en tu navegador (localStorage).
            </p>
        </div>
    </div>

    <!-- Overlay -->
    <div id="overlay" onclick="toggleAI()" class="fixed inset-0 bg-black/20 backdrop-blur-sm z-40 hidden transition-opacity opacity-0"></div>

    <script>
        // --- DATA ---
        const matrixData = [
            { task: "Análisis normativo",                   vals: ["C", "A", "C", "R", "I", "I", "I"] },
            { task: "Diseño arquitectura técnica",          vals: ["R", "I", "I", "I", "A", "I", "C"] },
            { task: "Configuración de microservicios",      vals: ["R", "I", "I", "I", "A", "I", "C"] },
            { task: "Carga y validación de catálogos",      vals: ["I", "C", "C", "R", "A", "I", "I"] },
            { task: "Construcción de pipelines ETL",        vals: ["R", "C", "I", "I", "A", "I", "C"] },
            { task: "Configuración de reglas normativas",   vals: ["I", "C", "C", "R", "A", "I", "I"] },
            { task: "Pruebas unitarias normativas",         vals: ["R", "C", "C", "R", "A", "I", "I"] },
            { task: "Pruebas integrales",                   vals: ["R", "C", "C", "C", "A", "I", "I"] }, 
            { task: "Configuración de seguridad",           vals: ["R", "C", "A", "I", "A", "I", "C"] },
            { task: "Configuración de roles/perfiles",      vals: ["R", "C", "A", "I", "A", "I", "I"] },
            { task: "Implementación Formato Normativo",     vals: ["C", "R", "C", "R", "A", "I", "I"] },
            { task: "Validación técnica de transmisión",    vals: ["R", "C", "C", "I", "A", "I", "I"] },
            { task: "Puesta en marcha",                     vals: ["R", "I", "I", "I", "A", "C", "C"] },
            { task: "Capacitación final",                   vals: ["C", "I", "I", "R", "A", "I", "I"] },
            { task: "Auditoría posterior",                  vals: ["I", "C", "C", "I", "R", "A", "I"] },
        ];

        const roles = [
            "Arquitectura TI", 
            "Riesgo", 
            "Cumplimiento", 
            "Área Normativa", 
            "Equipo Técnico TÓTAL", 
            "Auditoría", 
            "Proveedor Infra"
        ];

        // --- RENDER TABLE ---
        const tbody = document.getElementById('tableBody');
        lucide.createIcons();

        function getBadge(letter) {
            const classes = `badge-${letter} badge-base w-8 h-8 flex items-center justify-center rounded-lg font-bold text-sm mx-auto transition-transform duration-200`;
            return `<div class="${classes}" data-type="${letter}">${letter}</div>`;
        }

        matrixData.forEach((row, index) => {
            const tr = document.createElement('tr');
            tr.className = "hover:bg-slate-50 transition-colors group";
            let html = `<td class="px-6 py-4 font-medium text-slate-800 bg-white border-r border-slate-200 group-hover:bg-slate-50 transition-colors sticky-shadow sticky left-0 z-10">${row.task}</td>`;
            row.vals.forEach((val, i) => {
                const isTotalTeam = i === 4; 
                const cellBg = isTotalTeam ? 'bg-blue-50/20' : '';
                html += `<td class="px-4 py-3 text-center ${cellBg} border-r border-slate-100 last:border-0" data-col="${i + 1}">${getBadge(val)}</td>`;
            });
            tr.innerHTML = html;
            tbody.appendChild(tr);
        });

        // --- INTERACTION LOGIC ---
        function resetHighlights() {
            document.querySelectorAll('td, th').forEach(el => el.classList.remove('bg-blue-50', 'text-blue-800'));
            document.querySelectorAll('[data-type]').forEach(el => {
                el.style.opacity = '1';
                el.classList.remove('highlight-cell');
            });
            document.getElementById('roleFilter').value = "-1";
        }

        function highlightType(type) {
            resetHighlights();
            document.querySelectorAll('[data-type]').forEach(el => el.style.opacity = '0.4');
            document.querySelectorAll(`[data-type="${type}"]`).forEach(el => {
                el.style.opacity = '1';
                el.classList.add('highlight-cell');
            });
        }

        function highlightColumn(colIndex) {
            resetHighlights();
            if(colIndex == -1) return;
            const header = document.querySelector(`th:nth-child(${parseInt(colIndex) + 1})`);
            if(header) header.classList.add('bg-blue-50', 'text-blue-800');
            const cells = document.querySelectorAll(`td:nth-child(${parseInt(colIndex) + 1})`);
            cells.forEach(cell => {
                cell.classList.add('bg-blue-50');
                const badge = cell.querySelector('div');
                if(badge) badge.classList.add('highlight-cell');
            });
        }

        // --- API KEY MANAGEMENT ---
        function getStoredKey() {
            return localStorage.getItem('gemini_api_key_raci_tool');
        }

        function openApiKeyModal() {
            const modal = document.getElementById('apiKeyModal');
            const content = document.getElementById('apiKeyModalContent');
            modal.classList.remove('hidden');
            // Trigger reflow
            void modal.offsetWidth;
            modal.classList.remove('opacity-0');
            content.classList.remove('scale-95');
            
            const existingKey = getStoredKey();
            if(existingKey) {
                document.getElementById('apiKeyInput').value = existingKey;
            }
        }

        function closeApiKeyModal() {
            const modal = document.getElementById('apiKeyModal');
            const content = document.getElementById('apiKeyModalContent');
            modal.classList.add('opacity-0');
            content.classList.add('scale-95');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        }

        function saveApiKey() {
            const key = document.getElementById('apiKeyInput').value.trim();
            if(!key) {
                alert("Por favor ingresa una API Key válida.");
                return;
            }
            localStorage.setItem('gemini_api_key_raci_tool', key);
            closeApiKeyModal();
            // Refresh AI state if open
            checkApiKeyStatus();
            alert("API Key guardada correctamente.");
        }

        function checkApiKeyStatus() {
            const key = getStoredKey();
            const warning = document.getElementById('apiKeyWarning');
            if(!key) {
                warning.classList.remove('hidden');
                return false;
            } else {
                warning.classList.add('hidden');
                return true;
            }
        }

        // --- AI LOGIC ---
        
        function toggleAI() {
            const panel = document.getElementById('aiPanel');
            const overlay = document.getElementById('overlay');
            const isOpen = !panel.classList.contains('translate-x-full');

            if (isOpen) {
                panel.classList.add('translate-x-full');
                overlay.classList.remove('opacity-100');
                setTimeout(() => overlay.classList.add('hidden'), 300);
            } else {
                overlay.classList.remove('hidden');
                // Trigger reflow
                void overlay.offsetWidth; 
                overlay.classList.add('opacity-100');
                panel.classList.remove('translate-x-full');
                checkApiKeyStatus();
            }
        }

        function displayUserMessage(text) {
            const output = document.getElementById('aiOutput');
            const div = document.createElement('div');
            div.className = "flex justify-end";
            div.innerHTML = `
                <div class="bg-blue-600 text-white p-3 rounded-lg rounded-tr-none text-sm max-w-[80%] shadow-sm">
                    ${text}
                </div>
            `;
            output.appendChild(div);
            output.classList.remove('hidden');
            document.getElementById('aiWelcome').classList.add('hidden');
            output.scrollTop = output.scrollHeight;
        }

        function displayAIMessage(htmlContent) {
            const output = document.getElementById('aiOutput');
            const div = document.createElement('div');
            div.className = "flex justify-start gap-3 items-start";
            div.innerHTML = `
                <div class="w-8 h-8 rounded-full bg-indigo-100 flex items-center justify-center flex-shrink-0 mt-1">
                    <i data-lucide="sparkles" class="w-4 h-4 text-indigo-600"></i>
                </div>
                <div class="bg-white border border-slate-200 p-4 rounded-lg rounded-tl-none text-sm max-w-[90%] shadow-sm prose prose-sm text-slate-700">
                    ${htmlContent}
                </div>
            `;
            output.appendChild(div);
            lucide.createIcons(); // Refresh icons in new content
            output.scrollTop = output.scrollHeight;
        }

        async function callGemini(promptText) {
            const apiKey = getStoredKey();
            
            if (!apiKey) {
                openApiKeyModal();
                return;
            }

            const loading = document.getElementById('aiLoading');
            loading.classList.remove('hidden');

            // Construct Contextual Prompt
            const context = `
                Eres un experto consultor en gestión de proyectos y matrices RACI.
                Analiza la siguiente matriz RACI (JSON) para un proyecto de implementación de reporte normativo:
                ROLES: ${JSON.stringify(roles)}
                MATRIZ: ${JSON.stringify(matrixData)}
                
                Instrucciones:
                1. Responde en Español.
                2. Sé conciso, profesional y directivo.
                3. Usa formato Markdown para negritas y listas.
                4. Si el usuario pide una auditoría, busca: Tareas sin Responsable (R), Tareas sin Aprobador (A), Roles sobrecargados.
            `;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{ text: context + "\n\nPREGUNTA USUARIO: " + promptText }]
                        }]
                    })
                });

                if (!response.ok) {
                    throw new Error("Error en la API. Verifica tu API Key.");
                }

                const data = await response.json();
                const aiText = data.candidates?.[0]?.content?.parts?.[0]?.text || "Lo siento, no pude procesar la respuesta.";
                
                loading.classList.add('hidden');
                displayAIMessage(marked.parse(aiText));

            } catch (error) {
                loading.classList.add('hidden');
                displayAIMessage(`<span class="text-red-500 font-bold">Error: ${error.message}</span><br><span class="text-xs text-red-400">Verifica que tu API Key sea correcta en la configuración.</span>`);
                console.error(error);
            }
        }

        async function runAudit() {
            displayUserMessage("Ejecutar Auditoría Técnica de la Matriz");
            await callGemini("Realiza una auditoría crítica de esta matriz. Identifica: 1) Tareas huérfanas (sin R o A). 2) Cuellos de botella (Roles con demasiadas A). 3) Sugerencias de mejora. Presenta los resultados en bullet points claros.");
        }

        async function askQuestion(q) {
            displayUserMessage(q);
            await callGemini(q);
        }

        async function handleCustomQuery() {
            const input = document.getElementById('userQuery');
            const q = input.value.trim();
            if (!q) return;
            
            input.value = '';
            displayUserMessage(q);
            await callGemini(q);
        }

        // Initialize check on load
        window.addEventListener('load', () => {
             // Optional: check on load if you want to prompt immediately
             // if(!getStoredKey()) openApiKeyModal();
        });
    </script>
</body>
</html>